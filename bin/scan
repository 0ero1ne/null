#!/usr//bin/env python3
# nmap parser
# 0.9-a1
# nmap parser with some cool features

# TODO
# - more tests
# - improve args check in main function
# EOT


# Libraries
import subprocess
import socket
import sys
import requests
import time
import sys
import os


# Global variables
class self:
	old_clients = []
	clients = []

# Logo
def logo():
    print("""\x1b[1;32m
                                  .::!!!!!!!:.
.!!!!!:.                        .:!!!!!!!!!!!!
~~~~!!!!!!.                 .:!!!!!!!!!UWWW$$$
    :$$NWX!!:           .:!!!!!!XUWW$$$$$$$$$P
    $$$$$##WX!:      .<!!!!UW$$$$"  $$$$$$$$#
    $$$$$  $$$UX   :!!UW$$$$$$$$$   4$$$$$*
    ^$$$B  $$$$\\     $$$$$$$$$$$$   d$$R"
      "*$bd$$$$      '*$$$$$$$$$$$o+#"
           ````          ```````
              \x1b[1;31mI see you...
""", end='\n')


# Get the local IP
def get_ip_address():
    # Get the IP through a socket
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    s.connect(("8.8.8.8", 80))
    return s.getsockname()[0]


# Parse function
def parse():
	for y in self.clients:
		if y not in self.old_clients:
			self.old_clients.append(y)
			up="say -v Alex "+y+" connected."
			os.system(up)

	for index,x in enumerate(self.old_clients):
		if x not in self.clients:
			down="say -v Alex "+x+" disconnected."
			os.system(down)
			self.old_clients.pop(index)		


# Scan function
def scan():
		# Setting variables
		ip=get_ip_address()
		subnet="24"
		self.clients = []

		# Outputs
		os.system("clear")
		logo()

		# Nmap process
		p = str(str(subprocess.Popen(
	                                	[r"sudo","nmap","-sn",ip+"/"+subnet],
	                                	stdout=subprocess.PIPE).communicate()
	                                	).split('\\n')).split('Nmap')[2:-2]

		# Parse data and store it into variables
		for x in p:
			name = x.split(" ")[4]
			ip = x.split(" ")[5][1:-3]
			mac = x.split(" ")[13]
			nvendor = x.split("(")[3][:-5]
	
			# Output
			print("\x1b[1;32mName:\x1b[1;33m",name+"\x1b[0m")
			print("\x1b[1;32mIP:\x1b[1;33m",ip+"\x1b[0m")
			print("\x1b[1;32mMAC:\x1b[1;33m",mac+"\x1b[0m")

			# Mac vendor extraction
			if len(sys.argv) > 1:
				vendor = requests.get("https://api.macvendors.com/"+mac)
				print("\x1b[1;32mVendor:\x1b[1;33m",vendor.text,"\n"+"\x1b[0m")
				time.sleep(1)
			else:
				print("\x1b[1;32mVendor:\x1b[1;33m",nvendor,"\n"+"\x1b[0m")

			# Add name to client list
			self.clients.append(name)

# Main function
def main():
		# If loop mode 
		if len(sys.argv) > 1:
			if sys.argv[1] == "-l":
				while KeyboardInterrupt:
					scan()
					parse()
					time.sleep(5)
		else:
			scan()

# Run program
main()